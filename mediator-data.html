<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<!--
`<mediator-data location="https://mediator-data.firebaseio-demo.com" data="{{data}}" folder="{{folder}}"></mediator-data>` 
@demo demo.html todo and badges
@demo badges.demo.html badges
-->

<dom-module id="mediator-data">
  <template>
    <iron-ajax auto url="{{dataUrl}}" last-response="{{dataAll}}"></iron-ajax>
    <iron-ajax id="set" method="PUT" content-type="application/json" url="{{setDataUrl}}" ></iron-ajax>
    <!-- <iron-localstorage name="{{folder}}" value="{{data}}"></iron-localstorage> -->
  </template>
</dom-module>
<script>
;(function () {
  Polymer({
    is: 'mediator-data',
    properties: {
      dataUrl: {computed:'getDataUrl(location)'},
      setDataUrl: {computed:'getSetDataUrl(location, folder)'},
      location: {type: String, value: 'https://mediator-data.firebaseio-demo.com/'},
      folder: {type: String, value: 'data'},
      default: {type: String, value: 'default'},
      data: {notify: true}
    },
    observers: [
      "load(dataAll, folder)",
      "loadLs(localStorage, folder)",
      "setDataFolder(data.*, folder, dataAll.*)",
      "setData(dataAll.*, folder)"
    ],
    loadLs: function (dataAll, folder) {
      this.data = this.getData(dataAll, folder)
    },
    load: function (dataAll, folder) {
      this.data = this.getData(dataAll, folder)
    },
    getDataUrl: function(location){
      if (location.substring(location.length - 1) === '/') {
        location = location.substring(0, location.length - 1)
      }
      if (location.indexOf("firebase")) {
        return location + "/.json"
      } else {
        return location
      }
    },
    getData: function(dataAll, folder){
      if (dataAll) {
        if (folder === '') {
          return dataAll
        } else {
          if (dataAll.hasOwnProperty(folder)) {
            return dataAll[folder]
          } else {
            if (dataAll.hasOwnProperty(this.default)) {
              return dataAll[this.default]
            }
            return {}
          }
        }
      } else {
        return {}
      }
    },
    setData: function(dataAll,folder){
      dataAll = this.dataAll
      if (dataAll) {
        if (dataAll.hasOwnProperty(folder)) {
          this.$.set.body = JSON.stringify(dataAll[folder]) 
          this.$.set.generateRequest()
        }
      }
    },
    setDataFolder: function(data, folder, dataAll){
      if (folder !== "") {
        if (!this.dataAll) {
          this.dataAll = {}
        }
      
        if (!this.dataAll.hasOwnProperty(folder)) {
          this.dataAll[folder] = {}
        }
        
        this.dataAll[folder] = this.data
         
        this.$.set.body = JSON.stringify(this.data)  //TODO
        this.$.set.generateRequest()
      }
    },
    getSetDataUrl: function(location,folder) {
      if (location.substring(location.length - 1) === '/') {
        location = location.substring(0,location.length - 1)
      }
      if (location.indexOf("firebase")) {
        if (folder === '') {
          return location + "/.json"
        } else {
          return location + "/" + folder + "/.json"
        }
      } else {
        return location + "/" + folder
      }
    }
  })
})()
</script>
