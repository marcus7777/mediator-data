<!-- <link rel="import" href="../iron-localstorage/iron-localstorage.html"> -->
<link rel="import" href="../iron-ajax/iron-ajax.html">
<!--
`<mediator-data location="https://mediator-data.firebaseio-demo.com" data="{{data}}" folder="{{folder}}"></mediator-data>` 
@demo demo.html todo and badges
@demo badges.demo.html badges
-->

<dom-module id="mediator-data">
  <template>
    <iron-ajax auto url="{{dataUrl}}" last-response="{{dataAll}}"></iron-ajax>
    <iron-ajax id="set" method="PUT" content-type="application/json" url="{{setDataUrl}}" ></iron-ajax>
    <!-- <iron-localstorage name="{{folder}}" value="{{localStorage}}">
    </iron-localstorage> -->
  </template>
</dom-module>
<script>
;(function () {
  Polymer({
    is: 'mediator-data',
    properties: {
      dataUrl: {computed:'getDataUrl(location)'},
      setDataUrl: {computed:'getSetDataUrl(location,folder)'},
      location: {type: String, value: 'https://mediator-data.firebaseio-demo.com/'},
      folder: {type: String, value: ''},
      data: {notify: true},
      asArray: {notify: true, value: []}
    },
    observers: [
      "load(dataAll, folder)","load(localStorage, folder)",
      "setDataFolder(data.*, folder, dataAll.*)",
      "setData(dataAll.*, folder)",
      "syncAsArray(data.*, folder)",
      "syncData(asArray.*, folder)"
    ],
    syncAsArray: function(data, folder) {
      console.log(this.data)
      if (data.path !== "data" || this.asArrayFolder !== folder) {

        //data to array
        var _data = data.base
        var keys = Object.keys(_data)
        var output = []
        
        for (var i = 0; i < keys.length; i++) {
          if ( (typeof _data[keys[i]] === "object") && (_data[keys[i]] !== null) ) {
            _data[keys[i]]._key = keys[i]
          }
          output.push(_data[keys[i]])
        }
        this.asArray = output     
        this.asArrayFolder = folder
        console.log(output)  
      }
    },
    syncData: function(asArray, folder) {
      //TODO flip syncAsArray
      if (asArray.path.indexOf('asArray.#') !== -1) {
        debugger;
        var keys = Object.keys(this.data)
        var key = asArray.path.replace('asArray.#','') * 1
        console.log(key)
        if (this.asArray.hasOwnProperty(key)) {
          //if (this.asArray[key].hasOwnProperty("_key")) {
           // key = this.asArray[key]._key
         // }
          this.data[keys[key]] = asArray.value
          this.set('dataAll.'+folder+'.'+keys[key], asArray.value)
          console.log("setit", asArray.value)
          
        } else {
          console.log("delit")
        }
      //  console.log(this.asArray[key])
      //  console.log(this.data)
        
        //console.log(asArray)
      }
    },
    load: function (dataAll, folder) {
      if (dataAll !== null && Object.keys(dataAll).length > 0) {
        this.data = this.getData(dataAll, folder)
      }
    },
    getDataUrl: function(location){
      if (location.substring(location.length - 1) === '/') {
        location = location.substring(0,location.length - 1)
      }
      if (location.indexOf("firebase")) {
        return location + "/.json"
      } else {
        return location
      }
    },
    getData: function(dataAll, folder){
      if (dataAll) {
        if (folder === '') {
          return dataAll
        } else {
          if (dataAll.hasOwnProperty(folder)) {
            return dataAll[folder]
          } else {
            return {}
          }
        }
      } else {
        return {}
      }
    },
    setData: function(dataAll,folder){
      dataAll = this.dataAll
      this.localStorage = this.dataAll
      
      if (dataAll) {
        if (dataAll.hasOwnProperty(folder)) {
          this.$.set.body = JSON.stringify(dataAll[folder]) 
          this.$.set.generateRequest()
        }
      }
    },
    setDataFolder: function(data, folder, dataAll){
      if (folder !== "") {
        if (!this.dataAll) {
          this.dataAll = {}
        }
      
        if (!this.dataAll.hasOwnProperty(folder)) {
          this.dataAll[folder] = {}
        }
        
        this.dataAll[folder] = this.data
        
        if (Object.keys(this.data).length > 0) {
          this.$.set.body = JSON.stringify(this.data)  //TODO dedup
          this.$.set.generateRequest()
        }
      }
    },
    getSetDataUrl: function(location,folder) {
      if (location.substring(location.length - 1) === '/') {
        location = location.substring(0,location.length - 1)
      }
      if (location.indexOf("firebase")) {
        if (folder === '') {
          return location + "/.json"
        } else {
          return location + "/" + folder + "/.json"
        }
      } else {
        return location + "/" + folder
      }
    }
  })
})()
</script>
