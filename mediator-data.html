<!-- <link rel="import" href="../iron-localstorage/iron-localstorage.html"> -->
<link rel="import" href="../iron-ajax/iron-ajax.html">
<!--
`<mediator-data location="https://mediator-data.firebaseio-demo.com" data="{{data}}" folder="{{folder}}"></mediator-data>` 
@demo demo.html todo and badges
@demo badges.demo.html badges
-->

<dom-module id="mediator-data">
  <template>
    <iron-ajax auto url="{{dataUrl}}" last-response="{{dataAll}}"></iron-ajax>
    <iron-ajax id="set" method="PUT" content-type="application/json" url="{{setDataUrl}}" ></iron-ajax>
    <!-- <iron-localstorage name="{{folder}}" value="{{localStorage}}">
    </iron-localstorage> -->
  </template>
</dom-module>
<script>
;(function () {
  Polymer({
    is: 'mediator-data',
    properties: {
      dataUrl: {computed:'getDataUrl(location)'},
      setDataUrl: {computed:'getSetDataUrl(location, folder)'},
      location: {type: String, value: 'https://mediator-data.firebaseio-demo.com/'},
      folder: {type: String, value: ''},
      data: {notify: true},
      asArray: {notify: true, value: []}
    },
    observers: [
      "load(dataAll.*, folder)",
      "setData(dataAll.*, folder)",
      "syncDataAll(data.*)",
      "syncAsArray(data.*)",
      "syncData(asArray.*, folder)"
    ],
    syncDataAll: function(data) {
      
      this.set('dataAll.'+this.folder.replace('/','.'), data.base)
    },
    syncAsArray: function(data) {
      var asA = objectToArray(data.base)
      if (this.asArray !== asA) {
        this.asArray = asA
      }
    },
    syncData: function(asArray, folder) {
      if (asArray.path.indexOf('asArray.#') !== -1) {
        if (!this.data) this.data = {}
        var keys = Object.keys(this.data)
        var key = asArray.path.replace('asArray.#','') * 1
        console.log(key)
        if (this.asArray.hasOwnProperty(key)) {
          
          this.set('dataAll.'+folder.replace('/','.')+'.'+keys[key], asArray.value)
          
          if (!this.get('dataAll.'+folder.replace('/','.'), this)) {
            this.set('dataAll.'+folder.replace('/','.'), {})
          }
          
          this.set('data.'+keys[key], asArray.value)
          
        } else {
          console.log("delit")
        }
      }
    },
    load: function (dataAll, folder) {
      if (dataAll.base !== null && Object.keys(dataAll.base).length > 0 && folder !== "" ) {
        
        var data = this.get('dataAll.'+folder.replace('/','.'), this)
          
        if (data !== this.data) {
          this.data = data 
          var asArray = objectToArray(this.data)
          if (asArray !== this.asArray) {
            this.asArray = asArray
          }
        }
      }
    },
    getDataUrl: function(location){
      if (location.substring(location.length - 1) === '/') {
        location = location.substring(0,location.length - 1)
      }
      if (location.indexOf("firebase")) {
        return location + "/.json"
      } else {
        return location
      }
    },
    getData: function(dataAll, folder){
      if (dataAll) {
        if (folder === '') {
          return dataAll
        } else {
          if (dataAll.hasOwnProperty(folder)) {
            return dataAll[folder]
          } else {
            return {}
          }
        }
      } else {
        return {}
      }
    },
    setData: function(dataAll,folder){
      data = JSON.stringify(this.get('dataAll.'+folder.replace('/','.'), this))
      
      if (data) {
        this.$.set.body = data
        this.$.set.generateRequest()
      }
    },
    getSetDataUrl: function(location,folder) {
      if (location.substring(location.length - 1) === '/') {
        location = location.substring(0,location.length - 1)
      }
      if (location.indexOf("firebase")) {
        if (folder === '') {
          return location + "/.json"
        } else {
          return location + "/" + folder + "/.json"
        }
      } else {
        return location + "/" + folder
      }
    },
    /** Add New Object to the folder */ 
    push: function(obj){
      
      if (!this.data) this.data = {}
      
      var num = Object.keys(this.data).length + 1
      var key
      
      if (('' + num).length === 1) {
        key = '00' + num + ' '
      } else if (('' + num).length === 2) {
        key = '0' + num + ' '
      } else {
        key = '' + num + ' '
      }
      if (!data.hasOwnProperty(key)) {
        this.set("data."+key, obj)
      } else {
        this.data[key+"-"+Math.floor(Math.random()*1000)] = obj
      }
    }
  })

function objectToArray(data) {
  var output = []
  if (data) {
    var keys = Object.keys(data)
    for (var i = 0; i < keys.length; i++) {
    //  if ((typeof data[keys[i]] === "object") && (data[keys[i]] !== null)) {
    //    data[keys[i]]._key = keys[i]
    //  }
      output.push(data[keys[i]])
    }
  }
  return output
}

})()
</script>
