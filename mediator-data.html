<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<!--
`<mediator-data location="https://mediator-data.firebaseio-demo.com" data="{{data}}" folder="{{folder}}"></mediator-data>` 
@demo demo.html todo and badges
@demo badges.demo.html badges
-->

<dom-module id="mediator-data"><template>
  <iron-ajax auto url="{{setDataUrl}}" last-response="{{data}}"></iron-ajax>
  <iron-localstorage name="{{_hashOfSetDataUrl}}" value="{{value}}"></iron-localstorage>
  <iron-ajax id="set" method="PUT" url="{{setDataUrl}}" ></iron-ajax>
  <iron-ajax auto url="{{defaultDataUrl}}" last-response="{{defaultData}}"></iron-ajax>
</template></dom-module>
<script>
;(function () {
  function pad(num, size) {
    var s = num+"";
    while (s.length < size) s = "0" + s;
    return s;
  }
  Polymer({
    is: 'mediator-data',
    properties: {
      dataUrl: {computed:'getDataUrl(location)'},
      setDataUrl: {computed:'getSetDataUrl(location, _folder)'},
      defaultDataUrl: {computed:'getSetDataUrl(location, defaultFolder)'},
      location: {type: String},
      defaultFolder: {type: String, value: 'default'},
      folder: {type: String},
      data: {notify: true},
      keep:{type: Array, value: ["local"]},
      asArray: {type: Array, notify: true},
      editDefault:{type: Boolean, value: false},
      sync: {type: Array, value: []},
      _folder: {computed:'get_folder(editDefault, defaultFolder, folder)'},
      getUntilData: {value:false, type: Boolean},
      _hashOfSetDataUrl: {computed:'hash(setDataUrl)'}
    },
    observers: [
      "load(defaultData, sync)",
      "syncAsArray(data.*)",
      "syncData(asArray.*)",
      "setData(data.*, setDataUrl, gotData, keep)",
      "localLoad(savedData)"
    ],
    localLoad: function(savedData) {
      if (!this.data && savedData && Object.keys(savedData).length !== 0) {
        this.set("data", savedData)
      }
    },
    syncAsArray: function(data) {
      var asA = objectToArray(data.base)
      if (JSON.stringify(this.asArray) !== JSON.stringify(asA)) {
        this.set("asArray", asA)
      }
    },
    syncData: function(asArray) {
      if (asArray.path.indexOf('asArray.#') !== -1) {
        if (!this.data) this.data = {}
        var keys = Object.keys(this.data)
        var re = /(?:asArray\.#)([0-9]*)/; 
        var key = re.exec(asArray.path)[1] * 1
        var re2 = /(?:asArray\.#)(?:[0-9]*)\.(.*)/;
        var innerKey = ''
        if (re2.test(asArray.path)) {
          innerKey = '.'+re2.exec(asArray.path)[1]
        }
        if (this.asArray.hasOwnProperty(key)) {
          this.set('data.'+keys[key]+innerKey, asArray.value)
        } else {
          console.log("del it todo")
        }
      } else if (asArray.path === 'asArray.splices') {
        if (asArray.value.keySplices[0].added.length === 0) {
          var copyTo = {}
          for (var index = 0; index < asArray.base.length; index++) {
            copyTo[pad(index,3)] = asArray.base[index]
          }
          this.set("data", copyTo)
        } else {
          this.push(asArray.base.pop())
        }
      } else if (asArray.path === 'asArray' && this.data) {
        if (JSON.stringify(objectToArray(this.data)) !== JSON.stringify(asArray.base)) {
          this.set("data",ArrayToObject(asArray.base))
        }
      } else if (asArray.path === "asArray.length") {
        
      }
      
    },
    load: function (defaultData, sync) {
      data = this.data || defaultData
      if (sync.length !== 0) {
        this.set("data", this.addUniques(data, defaultData, sync))
      } else {
        if (JSON.stringify(data) !== JSON.stringify(this.data)) {
          this.set("data", data)
        }
      }
      this.gotData = JSON.stringify(data)
    },
    getDataUrl: function(location){
      if (location.substring(location.length - 1) === '/') {
        location = location.substring(0,location.length - 1)
      }
      if (location.indexOf("firebase")) {
        return location + "/.json"
      } else {
        return location
      }
    },
    get_folder: function(editDefault, defaultFolder, folder){
      if (editDefault) {
        return defaultFolder
      } else {
        return folder
      }
    },
    setData: function(data, setDataUrl, gotData, keep){ if (setDataUrl && data && gotData && keep) {
      if (gotData !== JSON.stringify(data.base)) {
        this.$.set.headers = {'content-type':'application/json'}
        this.$.set.body = JSON.stringify(this.dropData(data.base, keep))
        this.$.set.generateRequest()
      }
    }},
    getSetDataUrl: function(location, folder) {
      if (location.substring(location.length - 1) === '/') {
        location = location.substring(0,location.length - 1)
      }
      if (location.indexOf("firebase")) {
        if (folder === '') {
          return location + "/.json"
        } else {
          return location + "/" + folder + "/.json"
        }
      } else {
        return location + "/" + folder
      }
    },
    push: function(obj){
      var folder = this._folder
      
      if (this.data) {
        var num = Object.keys(this.data).length + 1
        var key = pad(num,3)
        
        if (!this.data.hasOwnProperty(key)) {
          this.set("data."+key, obj)
        } else {
          this.set("data."+key+"-"+pad(Math.floor(Math.random()*10000),4), obj)
        }
      } else {
        this.set("data", {"001": obj})
      }
    },
    addUniques: function(data, _default, sync) {
      var output = data
      if (_default && Array.isArray(sync)) {
        for (defaultKey in _default) {
          if (_default.hasOwnProperty(defaultKey)) {
            defaultItem = _default[defaultKey]
            var gotToGet = sync.length
            for (key in data) {
              var item = data[key]
              for (syncKey in sync) {
                if (sync.hasOwnProperty(syncKey)) {
                  var syncItem = sync[syncKey]
                  if (item[syncItem] && defaultItem[syncItem]) {
                    if (item[syncItem] === defaultItem[syncItem]) {
                      gotToGet = gotToGet - 1
                    }
                  } else {
                    gotToGet = 0
                  }
                }
              }
            }
          }
          if (gotToGet !== 0) {
            this.push(defaultItem)
          }
        }
      }
      return output
    },
    dropData: function(data, drop) {
      var output = {}
      if (Array.isArray(drop) && drop.length !== 0 && typeof data === 'object' && data !== null) {
        Object.keys(data).forEach(function(key) {
          if (drop.indexOf(key) === -1) { 
            if (typeof data[key] === 'string') {
              output[key] = data[key] 
            } else {
              output[key] = {}
              Object.keys(data[key]).forEach(function(key2) {
                if (drop.indexOf(key2) === -1) { 
                  output[key][key2] = data[key][key2]
                }
              })
            }
          }
        })
      } else {
        output = data
      }
      return output
    },
    hash: function(message) {
      function hex32(val) {
        val &= 0xFFFFFFFF
        var hex = val.toString(16).toUpperCase()
        return ("00000000" + hex).slice(-8)
      }
      var hash = 0
      if (message.length === 0) return hash
      for (i = 0;i < message.length;i++) {
        var char = message.charCodeAt(i)
        hash = ((hash<<5)-hash)+char
        hash = hash & hash // Convert to 32bit integer
      }
      return hex32(hash)
    }
  })
  function objectToArray(data) {
    var output = []
    if (data) {
      var keys = Object.keys(data)
      for (var i = 0; i < keys.length; i++) {
        output.push(data[keys[i]])
      }
    }
    return output
  }
  function ArrayToObject(data) {
    var output = {}
    if (data) {
      for (var i = 0; i < data.length; i++) {
        output[pad(i+1,3)] = data[i]
      }
    }
    return output
  }
})()
</script>
