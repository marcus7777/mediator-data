<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../firebase-element/firebase-collection.html">
<!--
`<mediator-data location="https://mediator-data.firebaseio-demo.com" data="{{data}}" folder="{{folder}}"></mediator-data>` 
@demo demo.html todo and badges
@demo badges.demo.html badges

-->

<dom-module id="mediator-data">
  <template>
    <firebase-collection location="{{_fullLocation}}"
      data="{{fbData}}" 
      on-firebase-value="_firebaseLoaded">
    </firebase-collection>
    
    <iron-localstorage name="{{folder}}" on-iron-localstorage-load="_backupLoaded" value="{{backupData}}">
    </iron-localstorage>
    
    <firebase-collection
      location="{{_fullLocationIfNoData}}"
      data="{{defaultDataFb}}"
      on-firebase-value="_firebaseDefaultLoaded">
    </firebase-collection>
    
  </template>
</dom-module>
<script>
;(function () {
  Polymer({
    is: 'mediator-data',
    properties: {
      location: {type: String, value: 'https://mediator-data.firebaseio-demo.com/'},
      folder: {type: String, value: 'todo'},
      data: {notify: true},
      _fullLocationIfNoData: {computed: '_cat(location, ifNoData)'},
      _fullLocation: {computed: '_cat(location, folder)'},
      _firebaseConnected: {value: false},
      _log: {value: false},
      _loadbk: {computed: '_firebaseLoadedBk(loadedFbData, loadedDefaultDataFb)'}
    },
    observers: [
      'debounceInput(data.*)','debounceFbInput(fbData.*)'
    ],
    debounceFbInput: function(fbData){
      this.debounce("_updateData", this._updateFbData, 3000)
    },
    _updateFbData: function (fbData) {
      if (this.data !== this.fbData) {
        this.data = this.fbData
      }
      if (this.fbData !== this.backupData) {
        this.backupData = this.fbData
      }
    },
    debounceInput: function(data){
      this.debounce("_updateData", this._updateData, 3000)
    },
    _updateData: function () {
      if (this.data !== this.fbData) {
        this.fbData = this.data
      }
      if (this.data !== this.backupData) {
        this.backupData = this.data
      }
    },
    _getDefaultData: function (defaultDataFb) {
      for (var i = 0; i < defaultDataFb.length; i++) {
        delete (defaultDataFb[i].__firebaseKey__)
     //   this.push("data",defaultDataFb[i])
        this.push("fbData",defaultDataFb[i])
    //    this.push("backupData",defaultDataFb[i])
      }
    },
    _firebaseDefaultLoaded: function () {
      this.loadedDefaultDataFb = this.defaultDataFb
    },
    _firebaseLoadedBk: function (loadedFbData, loadedDefaultDataFb) {
      if (loadedFbData.length < 1 && loadedDefaultDataFb.length > 1) {
        this._getDefaultData(loadedDefaultDataFb)
      }
    },
    _firebaseLoaded: function () {
      this._firebaseConnected = true
      this.data = this.fbData
      this.loadedFbData = this.fbData
      this.backupData = this.fbData
    },
    _backupLoaded: function () {
      if (!this._firebaseConnected) {
        this.data = this.backupData.slice()
      }
    },
    _cat: function (a, b) {
      return a + b
    }
  })
})()
</script>
