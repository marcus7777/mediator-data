<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../firebase-element/firebase-collection.html">
<!--
`<mediator-data location="https://mediator-data.firebaseio-demo.com" data="{{data}}" folder="{{folder}}"></mediator-data>` 
@demo demo.html todo and badges
@demo badges.demo.html badges

-->

<dom-module id="mediator-data">
  <template>
    <firebase-collection
      location="{{_fullLocationIfNoData}}"
      data="{{fbDataBk}}"
    ></firebase-collection>
    <firebase-collection location="{{_fullLocation}}"
      ref="{{ref}}" data="{{fbData}}" on-firebase-value="_firebaseLoaded"
      log=[[_log]]></firebase-collection>
    <iron-localstorage name="{{folder}}" on-iron-localstorage-load="_backupLoaded" value="{{backupData}}">
    </iron-localstorage>
  </template>
</dom-module>
<script>
(function () {
  Polymer({
    is: "mediator-data",
    properties: {
      location: {type:String, value:"https://mediator-data.firebaseio-demo.com/"},
      folder:{type:String, value:"todo"},
      data: {notify: true},
      _fullLocationIfNoData: {computed: "_cat(location, ifNoData)"},
      _fullLocation: {computed: "_cat(location, folder)"},
      _firebaseConnected: {value: false},
      _log: {value: false},
      _loadbk: {computed:"_firebaseLoadedBk(fbData, fbDataBk)"}
    },
    _firebaseLoadedBk: function(fbData, fbDataBk) {
      if ((!fbData || fbData.length < 1) && this.notSetFromBk) {
        this.fbData = clone(fbDataBk)
        this.notSetFromBk = false
      }
    },    
    _firebaseLoaded: function() {
      this._firebaseConnected = true;
      this.data = this.fbData;
      this.backupData = this.fbData;
      this.linkPaths('fbData', 'data');
      this.linkPaths('backupData', 'data');
      if (this._log) {
        console.log(data, this.data)
      }
    },
    _backupLoaded: function() {
      if (!this._firebaseConnected) {
        this.data = this.backupData.slice();
      }
    },
    _cat: function(a, b) {
      return a+b;
    }
  });
  function clone(obj) {
    var copy;
    // Handle the 3 simple types, and null or undefined
    if (null == obj || "object" != typeof obj) return obj;
    // Handle Date
    if (obj instanceof Date) {
      copy = new Date();
      copy.setTime(obj.getTime());
      return copy;
    }
    // Handle Array
    if (obj instanceof Array) {
      copy = [];
      for (var i = 0, len = obj.length; i < len; i++) {
        copy[i] = clone(obj[i]);
      }
      return copy;
    }
    // Handle Object
    if (obj instanceof Object) {
      copy = {};
      for (var attr in obj) {
        if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
      }
      return copy;
    }
    throw new Error("Unable to copy obj! Its type isn't supported.");
  }
})();
</script>
